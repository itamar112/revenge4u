<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<title>Revenge4U</title>
<style>
  body { font-family: Arial; direction: rtl; background: #f5f5f5; text-align: center; padding: 20px; }
  .container { background: white; padding: 20px; border-radius: 12px; display: inline-block; max-width: 400px; }
  input { padding: 10px; margin: 5px; width: 90%; box-sizing: border-box; }
  button { padding: 10px 20px; margin: 5px; }
  .hidden { display: none; }
  ul { padding-inline-start: 0; }
  li { background: #eee; margin: 6px 0; padding: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
  .close-btn { background: #d9534f; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 5px 10px; }
</style>
</head>
<body>

<h1>Revenge4U</h1>

<div id="auth-section" class="container">
  <h2>התחברות / הרשמה</h2>
  <input type="email" id="email" placeholder="אימייל" />
  <input type="password" id="password" placeholder="סיסמה" />
  <br />
  <button id="registerBtn">הרשמה</button>
  <button id="loginBtn">התחברות</button>
  <p id="authMessage"></p>
</div>

<div id="app-section" class="container hidden">
  <div>
    <img id="profile-pic" src="https://103fm.maariv.co.il/download/highlight/SegmentImgNew_600309_1_54_.jpg" width="50" height="50" style="border-radius:50%" />
    <span id="username"></span>
  </div>
  <h3>הנקמות שלך</h3>
  <ul id="revenge-list"></ul>
  <input type="text" id="new-revenge" placeholder="הכנס נקמה חדשה" />
  <button id="addRevengeBtn">הוסף נקמה</button>
  <br /><br />
  <button id="proBtn">שדרג ל-PRO</button>
  <button id="cancelProBtn" class="hidden">ביטול הפרו בגלל שאין כסף כי את קופאית בסופר</button>
  <p id="proStatus"></p>
  <br /><button id="logoutBtn">התנתק</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkY_RwQ4EsrqJGhAXYYka08XfOJ5vVCzM",
    authDomain: "revenge4u-1.firebaseapp.com",
    projectId: "revenge4u-1",
    storageBucket: "revenge4u-1.appspot.com",
    messagingSenderId: "886478866355",
    appId: "1:886478866355:web:8a82e399a38b65c8f3edc6",
    measurementId: "G-HLRC0W31DG"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const emailInput = document.getElementById("email");
  const passInput = document.getElementById("password");
  const authMsg = document.getElementById("authMessage");

  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");
  const usernameDisplay = document.getElementById("username");
  const revengeList = document.getElementById("revenge-list");
  const newRevengeInput = document.getElementById("new-revenge");
  const proBtn = document.getElementById("proBtn");
  const cancelProBtn = document.getElementById("cancelProBtn");
  const proStatus = document.getElementById("proStatus");

  let currentUser = null;

  document.getElementById("registerBtn").onclick = () => {
    createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
      .then(() => {
        authMsg.innerText = "נרשמת בהצלחה, התחבר כעת";
      })
      .catch(err => {
        authMsg.innerText = err.message;
      });
  };

  document.getElementById("loginBtn").onclick = () => {
    signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
      .catch(err => {
        authMsg.innerText = err.message;
      });
  };

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      usernameDisplay.innerText = user.email;
      loadData();
      authSection.classList.add("hidden");
      appSection.classList.remove("hidden");
    } else {
      currentUser = null;
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }
  });

  async function loadData() {
    const userDocRef = doc(db, "users", currentUser.uid);
    const docSnap = await getDoc(userDocRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      revengeList.innerHTML = "";
      (data.revenges || []).forEach(r => addRevengeToList(r));
      if (data.pro) {
        proStatus.innerText = "אתה ב-PRO";
        proBtn.classList.add("hidden");
        cancelProBtn.classList.remove("hidden");
      } else {
        proStatus.innerText = "לא ב-PRO";
        proBtn.classList.remove("hidden");
        cancelProBtn.classList.add("hidden");
      }
    } else {
      await setDoc(userDocRef, { revenges: [], pro: false });
      revengeList.innerHTML = "";
      proStatus.innerText = "לא ב-PRO";
      proBtn.classList.remove("hidden");
      cancelProBtn.classList.add("hidden");
    }
  }

  document.getElementById("addRevengeBtn").onclick = async () => {
    const txt = newRevengeInput.value.trim();
    if (!txt) return;
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, {
      revenges: arrayUnion(txt)
    });
    addRevengeToList(txt);
    newRevengeInput.value = "";
  };

  function addRevengeToList(txt) {
    const li = document.createElement("li");
    li.innerText = txt;

    // יצירת כפתור סגירה
    const closeBtn = document.createElement("button");
    closeBtn.innerText = "סגור נקמה זו";
    closeBtn.classList.add("close-btn");
    closeBtn.onclick = () => removeRevenge(txt, li);

    li.appendChild(closeBtn);
    revengeList.appendChild(li);
  }

  async function removeRevenge(txt, liElement) {
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, {
      revenges: arrayRemove(txt)
    });
    revengeList.removeChild(liElement);
  }

  proBtn.onclick = async () => {
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, { pro: true });
    proStatus.innerText = "אתה ב-PRO";
    proBtn.classList.add("hidden");
    cancelProBtn.classList.remove("hidden");
  };

  cancelProBtn.onclick = async () => {
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, { pro: false });
    alert("למה להיות אמנון");
    proStatus.innerText = "לא ב-PRO";
    proBtn.classList.remove("hidden");
    cancelProBtn.classList.add("hidden");
  };

  document.getElementById("logoutBtn").onclick = () => {
    signOut(auth);
  };
</script>

</body>
</html>
