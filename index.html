<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<title>Revenge4U - עם סל מחזור</title>
<style>
  body {
    font-family: Arial, sans-serif;
    direction: rtl;
    background: #8b0000;
    color: white;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  .container {
    background: #a00000;
    padding: 25px 30px;
    border-radius: 15px;
    max-width: 420px;
    margin: 20px auto;
    box-shadow: 0 0 15px #5a0000;
  }
  input {
    padding: 12px;
    margin: 8px 0;
    width: 90%;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    box-sizing: border-box;
  }
  button {
    padding: 12px 25px;
    margin: 10px 5px;
    font-size: 16px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }
  button#registerBtn, button#loginBtn {
    background: #e60000;
    color: white;
  }
  button#registerBtn:hover, button#loginBtn:hover {
    background: #ff1a1a;
  }
  button#addRevengeBtn, button#proBtn {
    background: #cc0000;
    color: white;
  }
  button#addRevengeBtn:hover, button#proBtn:hover {
    background: #ff3333;
  }
  button#cancelProBtn {
    background: #660000;
    color: white;
  }
  button#cancelProBtn:hover {
    background: #990000;
  }
  button#logoutBtn {
    background: #4d0000;
    color: #ffa6a6;
  }
  button#logoutBtn:hover {
    background: #730000;
  }
  ul {
    list-style-type: none;
    padding-inline-start: 0;
    margin-top: 15px;
  }
  li {
    background: #cc3333;
    margin: 8px 0;
    padding: 12px 15px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
  }
  .close-btn, .recycle-btn, .delete-btn {
    background: #990000;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    padding: 7px 12px;
    font-size: 14px;
    transition: background-color 0.3s ease;
    margin-left: 8px;
  }
  .close-btn:hover, .recycle-btn:hover, .delete-btn:hover {
    background: #ff4d4d;
  }
  #profile-pic {
    border: 3px solid #ff6666;
    border-radius: 50%;
  }
  #username {
    margin-right: 10px;
    font-size: 18px;
    font-weight: bold;
    color: #fff;
  }
  #authMessage {
    color: #ffb3b3;
    margin-top: 10px;
    min-height: 20px;
  }
  #proStatus {
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
    color: #ffcccc;
  }
  #trash-section {
    margin-top: 20px;
    text-align: center;
  }
  #trash-section h3 {
    margin-bottom: 10px;
  }
  .hidden {
    display: none !important;
  }
</style>
</head>
<body>

<h1>Revenge4U - קופה ראשית עם סל מחזור</h1>

<div id="auth-section" class="container">
  <h2>התחברות / הרשמה</h2>
  <input type="email" id="email" placeholder="אימייל" />
  <input type="password" id="password" placeholder="סיסמה" />
  <br />
  <button id="registerBtn">הרשמה</button>
  <button id="loginBtn">התחברות</button>
  <p id="authMessage"></p>
</div>

<div id="app-section" class="container hidden">
  <div style="display:flex; align-items:center; justify-content:center; margin-bottom:15px;">
    <span id="username"></span>
    <img id="profile-pic" src="https://103fm.maariv.co.il/download/highlight/SegmentImgNew_600309_1_54_.jpg" width="60" height="60" />
  </div>

  <h3>הנקמות שלך</h3>
  <ul id="revenge-list"></ul>
  <input type="text" id="new-revenge" placeholder="הכנס נקמה חדשה" />
  <button id="addRevengeBtn">הוסף נקמה</button>

  <div id="trash-section" class="hidden">
    <h3>סל מחזור - נקמות שנסגרו</h3>
    <ul id="trash-list"></ul>
  </div>

  <br />
  <button id="proBtn">שדרג ל-PRO</button>
  <button id="cancelProBtn" class="hidden">ביטול הפרו בגלל שאין כסף כי את קופאית בסופר</button>
  <p id="proStatus"></p>
  <br />
  <button id="logoutBtn">התנתק</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { 
    getAuth, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut 
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc, 
    updateDoc, 
    arrayUnion, 
    arrayRemove 
  } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkY_RwQ4EsrqJGhAXYYka08XfOJ5vVCzM",
    authDomain: "revenge4u-1.firebaseapp.com",
    projectId: "revenge4u-1",
    storageBucket: "revenge4u-1.appspot.com",
    messagingSenderId: "886478866355",
    appId: "1:886478866355:web:8a82e399a38b65c8f3edc6",
    measurementId: "G-HLRC0W31DG"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const emailInput = document.getElementById("email");
  const passInput = document.getElementById("password");
  const authMsg = document.getElementById("authMessage");

  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");
  const usernameDisplay = document.getElementById("username");
  const revengeList = document.getElementById("revenge-list");
  const newRevengeInput = document.getElementById("new-revenge");
  const proBtn = document.getElementById("proBtn");
  const cancelProBtn = document.getElementById("cancelProBtn");
  const proStatus = document.getElementById("proStatus");
  const trashSection = document.getElementById("trash-section");
  const trashList = document.getElementById("trash-list");

  let currentUser = null;

  // הרשמה
  document.getElementById("registerBtn").onclick = () => {
    authMsg.innerText = "";
    if (!emailInput.value || !passInput.value) {
      authMsg.innerText = "אנא מלא אימייל וסיסמה";
      return;
    }
    createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
      .then(() => {
        authMsg.innerText = "נרשמת בהצלחה, התחבר כעת";
      })
      .catch(err => {
        authMsg.innerText = err.message;
      });
  };

  // התחברות
  document.getElementById("loginBtn").onclick = () => {
    authMsg.innerText = "";
    if (!emailInput.value || !passInput.value) {
      authMsg.innerText = "אנא מלא אימייל וסיסמה";
      return;
    }
    signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
      .catch(err => {
        authMsg.innerText = err.message;
      });
  };

  // מעקב אחרי שינויי התחברות
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      usernameDisplay.innerText = user.email;
      loadData();
      authSection.classList.add("hidden");
      appSection.classList.remove("hidden");
    } else {
      currentUser = null;
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      authMsg.innerText = "";
      revengeList.innerHTML = "";
      trashList.innerHTML = "";
      proStatus.innerText = "";
      newRevengeInput.value = "";
      trashSection.classList.add("hidden");
    }
  });

  // טעינת נתוני נקמות ופרו וסל מחזור
  async function loadData() {
    if (!currentUser || !currentUser.uid) return;
    const userDocRef = doc(db, "users", currentUser.uid);
    const docSnap = await getDoc(userDocRef);
    if (docSnap.exists()) {
      const data = docSnap.data();

      // נקמות פעילות
      revengeList.innerHTML = "";
      (data.revenges || []).forEach(r => addRevengeToList(r));

      // סל מחזור
      if ((data.revengesTrash || []).length > 0) {
        trashSection.classList.remove("hidden");
        trashList.innerHTML = "";
        (data.revengesTrash || []).forEach(r => addTrashToList(r));
      } else {
        trashSection.classList.add("hidden");
        trashList.innerHTML = "";
      }

      // פרו
      if (data.pro) {
        proStatus.innerText = "אתה ב-PRO";
        proBtn.classList.add("hidden");
        cancelProBtn.classList.remove("hidden");
      } else {
        proStatus.innerText = "לא ב-PRO";
        proBtn.classList.remove("hidden");
        cancelProBtn.classList.add("hidden");
      }
    } else {
      // אם אין משתמש במסד, צור אחד חדש עם נקמות ריקות, סל מחזור ריק ופרו=כוזב
      await setDoc(userDocRef, { revenges: [], revengesTrash: [], pro: false });
      revengeList.innerHTML = "";
      trashList.innerHTML = "";
      trashSection.classList.add("hidden");
      proStatus.innerText = "לא ב-PRO";
      proBtn.classList.remove("hidden");
      cancelProBtn.classList.add("hidden");
    }
  }

  // הוספת נקמה חדשה לרשימה ולאשף Firestore
  document.getElementById("addRevengeBtn").onclick = async () => {
    const txt = newRevengeInput.value.trim();
    if (!txt) return;
    if (!currentUser || !currentUser.uid) {
      authMsg.innerText = "אתה חייב להתחבר כדי להוסיף נקמה";
      return;
    }
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, {
      revenges: arrayUnion(txt)
    });
    addRevengeToList(txt);
    newRevengeInput.value = "";
  };

  // הוספת נקמה פעילה לרשימה ב-HTML עם כפתור סגירה (מעבר לסל מחזור)
  function addRevengeToList(txt) {
    const li = document.createElement("li");
    li.innerText = txt;

    const closeBtn = document.createElement("button");
    closeBtn.innerText = "סגור נקמה זו";
    closeBtn.classList.add("close-btn");
    closeBtn.onclick = () => moveToTrash(txt, li);

    li.appendChild(closeBtn);
    revengeList.appendChild(li);
  }

  // העברת נקמה לסל מחזור (remove מהרשימה הפעילה, להוסיף לסל)
  async function moveToTrash(txt, liElement) {
    if (!currentUser || !currentUser.uid) return;
    const userDocRef = doc(db, "users", currentUser.uid);

    // הסר מהרשימה הפעילה
    await updateDoc(userDocRef, {
      revenges: arrayRemove(txt),
      revengesTrash: arrayUnion(txt)
    });

    // הסר מה-UI הפעיל והוסף לסל מחזור
    revengeList.removeChild(liElement);
    addTrashToList(txt);

    // הצג סל מחזור אם מוסתר
    trashSection.classList.remove("hidden");
  }

  // הוספת נקמה לסל המחזור עם כפתורי מחזור ומחיקה לצמיתות
  function addTrashToList(txt) {
    const li = document.createElement("li");
    li.innerText = txt;

    const recycleBtn = document.createElement("button");
    recycleBtn.innerText = "מחזור";
    recycleBtn.classList.add("recycle-btn");
    recycleBtn.onclick = () => recycleFromTrash(txt, li);

    const deleteBtn = document.createElement("button");
    deleteBtn.innerText = "מחק לצמיתות";
    deleteBtn.classList.add("delete-btn");
    deleteBtn.onclick = () => deleteFromTrash(txt, li);

    li.appendChild(deleteBtn);
    li.appendChild(recycleBtn);
    trashList.appendChild(li);
  }

  // מחזור נקמה מהסל חזרה לנקמות פעילות
  async function recycleFromTrash(txt, liElement) {
    if (!currentUser || !currentUser.uid) return;
    const userDocRef = doc(db, "users", currentUser.uid);

    await updateDoc(userDocRef, {
      revengesTrash: arrayRemove(txt),
      revenges: arrayUnion(txt)
    });

    trashList.removeChild(liElement);
    addRevengeToList(txt);

    // אם סל מחזור ריק, הסתר אותו
    if (trashList.children.length === 0) {
      trashSection.classList.add("hidden");
    }
  }

  // מחיקה לצמיתות מהסל מחזור
  async function deleteFromTrash(txt, liElement) {
    if (!currentUser || !currentUser.uid) return;
    const userDocRef = doc(db, "users", currentUser.uid);

    await updateDoc(userDocRef, {
      revengesTrash: arrayRemove(txt)
    });

    trashList.removeChild(liElement);

    // אם סל מחזור ריק, הסתר אותו
    if (trashList.children.length === 0) {
      trashSection.classList.add("hidden");
    }
  }

  // שדרוג ל-PRO (סימולציה)
  proBtn.onclick = async () => {
    if (!currentUser || !currentUser.uid) return;
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, { pro: true });
    proStatus.innerText = "אתה ב-PRO";
    proBtn.classList.add("hidden");
    cancelProBtn.classList.remove("hidden");
  };

  // ביטול פרו עם הודעה מצחיקה
  cancelProBtn.onclick = async () => {
    if (!currentUser || !currentUser.uid) return;
    const userDocRef = doc(db, "users", currentUser.uid);
    await updateDoc(userDocRef, { pro: false });
    alert("למה להיות אמנון");
    proStatus.innerText = "לא ב-PRO";
    proBtn.classList.remove("hidden");
    cancelProBtn.classList.add("hidden");
  };

  // התנתקות
  document.getElementById("logoutBtn").onclick = () => {
    if (!auth) return;
    signOut(auth).then(() => {
      console.log("התנתקת בהצלחה");
    }).catch(err => {
      console.error("שגיאה בהתנתקות:", err);
    });
  };
</script>

</body>
</html>
